<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Claim Form - Purchase Requisition System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 10px 5px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 8px 5px;
            border-bottom: 1px solid #ddd;
        }

        td input[type="text"],
        td input[type="number"],
        td input[type="date"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        td input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-add {
            background: #28a745;
            color: white;
            padding: 8px 20px;
            margin-bottom: 10px;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            max-width: 400px;
            margin-left: auto;
        }

        .totals-label {
            font-weight: 600;
            text-align: right;
        }

        .totals-value {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“‹ Expense Claim Form</h1>

        <div id="alert" class="alert"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <form id="expenseClaimForm">
            <!-- Employee Information -->
            <div class="form-section">
                <h2>Employee Information</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="onBehalfOf" style="width: 20px; height: 20px; margin-right: 10px;" onchange="toggleOnBehalfOf()">
                        <span style="font-size: 14px;">Submit on behalf of someone else</span>
                    </label>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="employee_name">Employee Name *</label>
                        <input type="text" id="employee_name" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="employee_number">Employee Number *</label>
                        <input type="text" id="employee_number" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <input type="text" id="department" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="km_rate">KM Rate (K) *</label>
                        <input type="number" id="km_rate" step="0.01" value="5.00" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="reason_for_trip">Reason for Trip *</label>
                        <textarea id="reason_for_trip" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Expense Items -->
            <div class="form-section">
                <h2>Expense Details</h2>
                <button type="button" class="btn btn-add" onclick="addExpenseRow()">+ Add Row</button>
                <div class="table-container">
                    <table id="expenseTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">No</th>
                                <th style="width: 100px;">Date</th>
                                <th style="width: 200px;">Details</th>
                                <th style="width: 80px;">KM</th>
                                <th style="width: 40px;">B</th>
                                <th style="width: 40px;">L</th>
                                <th style="width: 40px;">D</th>
                                <th style="width: 100px;">Meals (K)</th>
                                <th style="width: 100px;">Accom (K)</th>
                                <th style="width: 100px;">Phone (K)</th>
                                <th style="width: 100px;">Total (K)</th>
                                <th style="width: 60px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody">
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Totals -->
            <div class="totals-section">
                <div class="totals-grid">
                    <div class="totals-label">Total Kilometers:</div>
                    <div class="totals-value" id="totalKM">0.00</div>

                    <div class="totals-label">Sub Total (Travel):</div>
                    <div class="totals-value" id="subTotal">K 0.00</div>

                    <div class="totals-label">Total Travel:</div>
                    <div class="totals-value" id="totalTravel">K 0.00</div>

                    <div class="totals-label">TOTAL CLAIM:</div>
                    <div class="totals-value" id="totalClaim" style="font-weight: bold; font-size: 18px;">K 0.00</div>

                    <div class="totals-label">Amount Advanced:</div>
                    <div class="totals-value">
                        <input type="number" id="amount_advanced" step="0.01" value="0"
                               style="text-align: right; width: 120px;" onchange="calculateTotals()">
                    </div>

                    <div class="totals-label">AMOUNT DUE:</div>
                    <div class="totals-value" id="amountDue" style="font-weight: bold; color: #28a745;">K 0.00</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Claim</button>
            </div>
        </form>
    </div>

    <script src="config.js"></script>
    <script>
        const API_URL = window.API_URL || 'http://localhost:3001/api';
        let rowCounter = 0;

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Load user data
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            document.getElementById('employee_name').value = userData.full_name || '';
            document.getElementById('employee_number').value = userData.employee_number || '';
            document.getElementById('department').value = userData.department || '';

            // Add initial row
            addExpenseRow();
        });

        function toggleOnBehalfOf() {
            const checkbox = document.getElementById('onBehalfOf');
            const nameField = document.getElementById('employee_name');
            const numberField = document.getElementById('employee_number');
            const deptField = document.getElementById('department');

            if (checkbox.checked) {
                // Enable fields for manual entry
                nameField.readOnly = false;
                numberField.readOnly = false;
                deptField.readOnly = false;
                nameField.value = '';
                numberField.value = '';
                deptField.value = '';
                nameField.focus();
            } else {
                // Restore user's own data
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                nameField.value = userData.full_name || '';
                numberField.value = userData.employee_number || '';
                deptField.value = userData.department || '';
                nameField.readOnly = true;
                numberField.readOnly = true;
                deptField.readOnly = true;
            }
        }

        function addExpenseRow() {
            rowCounter++;
            const tbody = document.getElementById('expenseTableBody');
            const row = tbody.insertRow();

            row.innerHTML = `
                <td><input type="text" class="report_no" value="${rowCounter}" readonly></td>
                <td><input type="date" class="date" required></td>
                <td><input type="text" class="details" required></td>
                <td><input type="number" class="km" step="0.01" value="0" onchange="calculateRow(this)"></td>
                <td><input type="checkbox" class="breakfast" onchange="calculateRow(this)"></td>
                <td><input type="checkbox" class="lunch" onchange="calculateRow(this)"></td>
                <td><input type="checkbox" class="dinner" onchange="calculateRow(this)"></td>
                <td><input type="number" class="meals" step="0.01" value="0" readonly></td>
                <td><input type="number" class="accommodation" step="0.01" value="0" onchange="calculateRow(this)"></td>
                <td><input type="number" class="phone" step="0.01" value="0" onchange="calculateRow(this)"></td>
                <td><input type="number" class="total" step="0.01" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger" onclick="deleteRow(this)">Ã—</button></td>
            `;
        }

        function deleteRow(button) {
            if (document.getElementById('expenseTableBody').rows.length > 1) {
                button.closest('tr').remove();
                calculateTotals();
            } else {
                showAlert('At least one expense row is required', 'error');
            }
        }

        function calculateRow(element) {
            const row = element.closest('tr');

            // Calculate meals (Breakfast: K50, Lunch: K100, Dinner: K100)
            const breakfast = row.querySelector('.breakfast').checked ? 50 : 0;
            const lunch = row.querySelector('.lunch').checked ? 100 : 0;
            const dinner = row.querySelector('.dinner').checked ? 100 : 0;
            const mealsTotal = breakfast + lunch + dinner;
            row.querySelector('.meals').value = mealsTotal.toFixed(2);

            // Calculate row total
            const km = parseFloat(row.querySelector('.km').value) || 0;
            const meals = parseFloat(row.querySelector('.meals').value) || 0;
            const accommodation = parseFloat(row.querySelector('.accommodation').value) || 0;
            const phone = parseFloat(row.querySelector('.phone').value) || 0;

            const rowTotal = meals + accommodation + phone;
            row.querySelector('.total').value = rowTotal.toFixed(2);

            calculateTotals();
        }

        function calculateTotals() {
            const rows = document.getElementById('expenseTableBody').rows;
            const kmRate = parseFloat(document.getElementById('km_rate').value) || 0;

            let totalKM = 0;
            let totalExpenses = 0;

            for (let row of rows) {
                const km = parseFloat(row.querySelector('.km').value) || 0;
                const total = parseFloat(row.querySelector('.total').value) || 0;

                totalKM += km;
                totalExpenses += total;
            }

            const subTotal = totalKM * kmRate;
            const totalTravel = subTotal;
            const totalClaim = totalTravel + totalExpenses;
            const amountAdvanced = parseFloat(document.getElementById('amount_advanced').value) || 0;
            const amountDue = totalClaim - amountAdvanced;

            document.getElementById('totalKM').textContent = totalKM.toFixed(2);
            document.getElementById('subTotal').textContent = 'K ' + subTotal.toFixed(2);
            document.getElementById('totalTravel').textContent = 'K ' + totalTravel.toFixed(2);
            document.getElementById('totalClaim').textContent = 'K ' + totalClaim.toFixed(2);
            document.getElementById('amountDue').textContent = 'K ' + amountDue.toFixed(2);
        }

        document.getElementById('expenseClaimForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const rows = document.getElementById('expenseTableBody').rows;
            if (rows.length === 0) {
                showAlert('Please add at least one expense item', 'error');
                return;
            }

            // Collect form data
            const items = [];
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                items.push({
                    report_no: parseInt(row.querySelector('.report_no').value),
                    date: row.querySelector('.date').value,
                    details: row.querySelector('.details').value,
                    km: parseFloat(row.querySelector('.km').value) || 0,
                    breakfast: row.querySelector('.breakfast').checked ? 1 : 0,
                    lunch: row.querySelector('.lunch').checked ? 1 : 0,
                    dinner: row.querySelector('.dinner').checked ? 1 : 0,
                    meals: parseFloat(row.querySelector('.meals').value) || 0,
                    accommodation: parseFloat(row.querySelector('.accommodation').value) || 0,
                    sundries_phone: parseFloat(row.querySelector('.phone').value) || 0,
                    total_zmw: parseFloat(row.querySelector('.total').value) || 0
                });
            }

            const totalKM = parseFloat(document.getElementById('totalKM').textContent);
            const kmRate = parseFloat(document.getElementById('km_rate').value);
            const subTotal = totalKM * kmRate;
            const totalTravel = parseFloat(document.getElementById('totalTravel').textContent.replace('K ', ''));
            const totalClaim = parseFloat(document.getElementById('totalClaim').textContent.replace('K ', ''));
            const amountAdvanced = parseFloat(document.getElementById('amount_advanced').value) || 0;
            const amountDue = parseFloat(document.getElementById('amountDue').textContent.replace('K ', ''));

            const claimData = {
                employee_name: document.getElementById('employee_name').value,
                employee_number: document.getElementById('employee_number').value,
                department: document.getElementById('department').value,
                reason_for_trip: document.getElementById('reason_for_trip').value,
                total_kilometers: totalKM,
                km_rate: kmRate,
                sub_total: subTotal,
                total_travel: totalTravel,
                total_claim: totalClaim,
                amount_advanced: amountAdvanced,
                amount_due: amountDue,
                items: items
            };

            try {
                showLoading(true);
                const token = localStorage.getItem('token');

                const response = await fetch(`${API_URL}/forms/expense-claims`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(claimData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Expense claim submitted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    showAlert(data.error || 'Failed to submit expense claim', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('An error occurred while submitting the claim', 'error');
            } finally {
                showLoading(false);
            }
        });

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
